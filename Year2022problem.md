# 京セラNVF-01の2022年問題

2022年以降に発生する問題をふたつ見つけました。

- データ削除問題
- ピーク値記録問題

いずれも、問題の原因は32ビット符号付き整数のオーバーフローです。
データベースの中身について、[Database.md](Database.md)に書いたように、分単位および10分単位のデータはYYMMDDhhmm形式の整数値でデータベースに書き込まれます。
2021年の最後は2112312359であり、2022年の最初は2201010000になります。
32ビット符号付き整数では、表せる最大値が2147483647ですから、2022年以降はこの範囲を超えてオーバーフローします。

ピーク値については分単位のデータではないのですが、内部の計算でなぜか分まで含む値が使われているようです。

## データ削除問題

### 概要

分単位のデータについては膨大な量になるので、3日分しか残らないようになっています。
ところが、`/mnt/khems/equip`にあるデータについて、2022年以降のデータが残り続ける問題が起きました。

動作を見ている限りは`/var/cachedb`についてはきちんと消されています。
`/mnt/khems/equip`のみ問題が発生するようです。
古いデータのクリーンナップはcrontabにより実行される`/home/khems/KHEMS_SCH`により実施されるようで、問題はこのプログラム内にあります。

### 放置した場合

データベースが巨大化し、`sensor_average301.db`と`sensor_average300.db`が15 MB近くに達しました。
ジャーナルファイルも同様のサイズですのでこれらだけで60 MBほどになります。
ファイルシステム的には空きがあるはずなのですが、以下のエラーが出ました:

```
May 17 22:04:52 freescale user.warn KHEMS: [pid=2543( KHEMS_MDM),tid=3203] MDM_Thread.cpp(454) vacuum():[Warning]:command:vacuum minute; sensor_average301.db Failure err=database or disk is full
```

このエラーでサービスはまったく動かなくなりました。

### 修正

#### 方法

問題のバイナリのMD5を以下に示します:

```
0b75769616e5df115c16c9f53b9f77a5  KHEMS_SCH
```

このバイナリの修正パッチを以下に示します:

```
--ADDRS----F1---F2-
00017130   94   1F
00017131   B4   00
00017132   FF   00
000171B0   B0   BA
000171B1   D0   CF
000171B2   8D   FF
000171B3   E2   EA
000171B4   F0   00
000171B5   47   30
000171B6   BD   A0
000171B7   E8   E3
000171B8   1E   2F
000171B9   FF   B5
000171BA   2F   FF
000171BB   E1   EA
```

crontabで定期的に実行されるのですが、それ以外にも実行タイミングを調整する何かがあるようです。
このプログラム自体は、RAMディスク上の`/var/cachedb`で随時更新されているデータベースを、永続ストレージに5分ごとに反映するというのがメインのタスクのようですので、削除処理は毎回は実施していないものと思われます。
修正したら一日くらい待ってみると良いでしょう。
うまくいけばデータベースの古いデータが消されます。
本体が再起動すると元に戻ってしまうのですが、2022年以降修正していなくても2年ぐらいは普通に大丈夫だったので、時々適用してあげればいいかと思います。

#### 詳細

バイナリの中を文字列検索するとSQL文が出てきます。
古いデータを消すとしてまず思い浮かべる通りの`delete from`です。

その文字列のアドレスから追っていくと、YYMMDDhhmmが64ビットの`long long`型で渡されてくるメソッドが見つかりました。
それはいいのですが、そのメソッドの中で、その値を`sqlite3_bind_int`関数に渡してしまったようです。
そのため、32ビットの`int`型にキャストされ見事にオーバーフローします。

上の修正は、上位32ビットを0にして`sqlite3_bind_int64`関数を呼ぶように改造するものです。
バイナリで`long long`型をそのまま渡す改造は簡単ではなかったので、このような修正となっています。
符号無し32ビットにおさまらなくなる2043年には、再び問題が発生するようになることでしょう。

## ピーク値記録問題

### 概要

`/mnt/khems/equip`の`pv_peak.db`を見ると、`month_peak`は2112、`year_peak`は21を最後に途絶えていました。
これらは桁数的には余裕なのですが、内部でYYMMDDhhmmを符号付き32ビット整数で扱っている部分があって、そうなります。

こちらは、容量あふれのような問題は発生しません。
しかし、月と年の発電電力ピーク値が表示されなくなります。
(専用アプリで ---- kW 表示になります。)

ピーク値の月・年単位の反映も、crontabにより実行される`/home/khems/KHEMS_SCH`により実施されるようで、問題はこのプログラム内にあります。
詳しくはわかりませんが、どうやら前日のピーク値を取得して比較し、必要に応じて更新する仕掛けのようです。

### 修正

#### 方法

問題のバイナリのMD5を以下に示します:

```
0b75769616e5df115c16c9f53b9f77a5  KHEMS_SCH
```

このバイナリの修正パッチを以下に示します:

```
--ADDRS----F1---F2-
0001897C   95   02
00018A7E   C7   87
00018A8A   CC   8C
00018A90   47   27
00018A92   63   A0
00018A93   E0   E1
00018A94   4C   2C
00018A96   63   A0
00018A97   E0   E1
00018D84   62   A5
00018D85   AF   AE
```

これもcrontabで定期的に実行されるのですが、ピーク値の月と年の値の反映は一日一回しか行われないようです。
修正したら一日くらい待ってみると良いでしょう。
うまくいけばピーク値の月と年の値が反映されていると思います。

#### 詳細

バイナリの中に、いかにもピーク値を更新しそうな名前のメソッドがあって、その中で`%y%m%d%H%M`という文字列が使われています。
`strftime`関数ではないようですが、同等の機能を持つメソッドがあるようです。
そうして、一度YYMMDDhhmmを文字列として生成した後に、`strtol`関数を呼び出して数値に変換しています。
その返り値を10000などで割って使用するようです。
しかし、この環境では`long`は32ビットですから、最大値は2147483647です。
2022年以降は、`strtol`関数の仕様により、常に2147483647になってしまいます。
`day_peak`に日付が214748となっているデータは存在しないので、永遠に更新されません。

上の修正は、この数値を符号無しの`unsigned long`にしようというものです。
まず`strtol`関数の呼び出しを`strtoll`関数に置き換え、返り値の下位32ビットのみを使います。
そして、割り算を符号無しに置き換えます。
YYMMDDhhmmを割る数には、以下の3種類が使われています:

- 10000で割って、答えはYYMMDD
- 1000000で割って、答えはYYMM
- 100000000で割って、答えはYY

このうち、10000と1000000には、かけ算命令とビット演算が使われています。
符号無しにするため、かけ算命令を符号無しにし、ビットシフトと同時に、負の数の時の補正をする引き算命令を、単なるビットシフト命令に置き換えます。
100000000についてはlibgccに含まれる`__aeabi_idiv`関数が使われているので、`__aeabi_uidiv`関数に置き換えます。

符号無し32ビットにおさまらなくなる2043年には、再び問題が発生するようになることでしょう。
