# 京セラNVF-01の話

NVF-01の技術的な話を書きます。
1ユーザーとしてわかったことをまとめます。
コンピューターエンジニア向けの内容です。

- 概要
- 簡単な話
- 難しい話

## 概要

2019年購入の京セラの家庭用太陽光発電システムは以下のような構成になっていました:

```
太陽光パネル
 |
 |
太陽光発電インバーター ----- 分電盤: 商用電源 (売電)
 |
 |
NVF-01 ----- 分電盤: 電流センサーと装置自体の電源
 :
 :
モニタ (LAVIE Tab E)
```

NVF-01にはSTモードとAPモードがありますが、APモードになっていました。
APモードでは、NVF-01が無線LANアクセスポイントとなり、Android端末であるLAVIE Tab Eはその無線LANアクセスポイントを介して太陽光発電システムのステータスを取得します。

インバーターは、NVF-01の状態にかかわらず、太陽光パネルが発電を開始すると稼働します。
インバーターは商用電源の周波数に同期して少し高めの電圧の交流を作り出します。
それが家庭内で消費されるか、外部に売られるかはインバーターの知るところではありません。
インバーターは出力した電力の情報をNVF-01に伝えます。
これは (おそらく) 独立運転時を除きます。

NVF-01はインバーターからの電力情報の他に分電盤の電流センサーから情報をもらって収集します。
電流センサーは、どっち向きにどれだけの電流が流れているかを見ます。
理屈の上では家の外についている電力メーターが見ているのと同じデータのはずです。

1000 Wの発電と、200 Wの売電であれば、買電はゼロで、800 Wが消費となります。
1000 Wの発電と、200 Wの買電であれば、売電はゼロで、合わせて1200 Wが消費となります。
そんな風にして、具体的な売電と買電と消費の値は簡単な足し算引き算で求められます。

## 簡単な話

設置担当の方も知っている簡単な内容です。

- 無線LANの設定
- 専用アプリ
- 時計

### 無線LANの設定

APモードの無線LANは、WPA2-PSKで暗号化されており、SSIDは`Kyocera_NVF-01`、pre-shared keyは本体に記載されているゲートウェイIDとなっていました。
チャネルは1、つまり2.412 GHzに固定されているようです。

IPアドレスは以下のようになっていました:

- NVF-01: 192.168.69.71/24 (ゲートウェイおよびDNSサーバー: 192.168.69.1)
- モニタ: 192.168.69.7/24 (ゲートウェイおよびDNSサーバー: 192.168.69.1)

モニタにもDHCPは使われておらず、静的に設定されていました。
おそらく設置時に設定されたものと思います。
設置時点でこのネットワークにはNVF-01とモニタしかないので、192.168.69.1にはつながりません。

### 専用アプリ

モニタにインストールされている京セラの専用アプリは、Google Playストアでも配布されています。
瞬時値表示 (売電電力または買電電力、太陽光発電、消費電力をそれぞれkW表示)、総合エネルギー (過去のデータ振り返り)、などの表示ができます。
蓄電システム等があればそれも表示できるんだと思いますが、未導入のため不明です。

モニタ以外の端末を使う場合、手持ちの端末にアプリをインストールしたら、NVF-01の無線LANに接続を切り替え、IPアドレスを適当にあいているところに割り当てて、アプリを起動すれば、自動的にNVF-01が検出され、情報が出るはずです。
一度検出に成功すればIPアドレスの情報が保存され、次からは探索することなく接続が行われると思います。

NVF-01の無線LANに接続しさえすれば、おそらく、ECHONET Liteに対応した他のアプリも使えるでしょう。

### 時計

NVF-01の時計の設定はアプリからではなく、webブラウザーで専用のURLにアクセスして行う形となっています。
URLは<http://192.168.69.71/detail_setting/time_synchro_setting_detail.php>となっていました。

NVF-01にはリアルタイムクロックが搭載されていないのかも知れません。
停電などでNVF-01がリセットされるたびに時計が数分ずつ遅れていきます。

システムの時計の精度はそんなに高くないです。
1 週間で 3 秒ぐらい平気でズレます。
モニタもインターネットにつながっておらず時計がズレていくので、このインターフェイスだけで合わせるのは面倒です。

## 難しい話

- TELNET
- システム
- 時計の設定
- 有線LANポート
- ログ
- ECHONET Lite
- Web
- 起動処理
- 無線LANデバイス
- USBポート
- データベース
- 2022年問題

### TELNET

NVF-01ではTELNETサーバーが動いています。
前述のAPモードの無線LANアクセスポイントにつながるよう適当にパソコンを設定して、普通にtelnetコマンドでアクセスすると以下のようにログインプロンプトが出てきます:

```
Trying 192.168.69.71...
Connected to 192.168.69.71.
Escape character is '^]'.


        Welcome to Freescale Semiconductor Embedded Linux Environment


freescale login:
```

ユーザー名は何でしょうね、となった時にまず思いつくrootを入れると、パスワード無しでログインできました:

```
freescale login: root


BusyBox v1.20.2 () built-in shell (ash)
Enter 'help' for a list of built-in commands.

root@freescale ~$ 
```

見ての通りBusyBoxがインストールされていて、内蔵コマンドもかなり多く組み込まれており比較的操作しやすいシェルになっています。
というかシステムの規模を考えるとめちゃくちゃ便利です。
TELNETサーバーをそのままにしておいてくださった開発者達に感謝します。

### システム

以下のように、オペレーティングシステムのカーネルはLinux 2.6.35、中央処理装置は32ビットのArmです:

```
root@freescale ~$ uname -a
Linux freescale 2.6.35.3-670-g914558e #59 PREEMPT Thu Dec 1 17:39:51 JST 2016 armv5tejl GNU/Linux
```

また、ランダムアクセスメモリー(RAM)は248 MiBほどあり、ストレージは/が60 MiBほど、ubifsが/mntにマウントされていて400 MiBちょっとの容量があります:

```
root@freescale ~$ free
             total         used         free       shared      buffers
Mem:        254704       111840       142864            0          956
-/+ buffers:             110884       143820
Swap:            0            0            0
root@freescale ~$ df 
Filesystem           1K-blocks      Used Available Use% Mounted on
/dev/root                62135     47129     11877  80% /
tmpfs                   127352        32    127320   0% /dev
shm                     127352         0    127352   0% /dev/shm
df: /mnt/rwfs: No such file or directory
ubi0:data               413452     15160    393456   4% /mnt
```

`/dev/root`と出ていますが実態はRAMディスク、initrdのようです。
ここは自由に書き換えることができますが、リセットすると元に戻ります。
ubifsのほうは永続なドライブです。
ubifsを不用意に書き換えると元に戻せなくなるかも知れないのでご注意ください。

カーネルソースについては<https://github.com/embest-tech/linux-imx/tree/imx_2.6.35_1.1.0>ではないかと思われます。
これならコミットIDが914558e17e95a55ac1eac9a6c219d17d7825f715なので、unameに表示されるものと一致します。
もちろん京セラに頼めば正しいものをもらうことができるはずです。

このカーネルは2020年時点で見てもとても古く、最新のGCCではビルドすることができません。
カーネルモジュールなどビルドしたい場合はGCCバージョン4を用意しましょう。

### 時計の設定

TELNETで接続したら普通にdateコマンドで時計を設定できるようです。
他にntpdateコマンドやntpdコマンドまであります。
そんなものまで残してくださった開発者様々です。

NTPを使う場合は`ntpd -p 192.168.69.1`のようにして立ち上げます。
もちろん、ntpdを立ち上げたところで、リセットすると元に戻るのですが、リセットするまでの間は時計を合わせ続けてくれることでしょう。
なお、NTPサーバーが同じネットワークで到達できない場合は、到達できるようにネットワークを設定しましょう。

`/var/cachedb/setting.db`の中を見ると、33に`ntp.nict.jp`というのが設定されています。
実はこれを使って時々ntpdateが実行されていそうな感じもあります。
もちろんインターネットにつながっていないのでそれはうまくいかないのですが。

`hwclock`コマンドも入っていて使えるので、リアルタイムクロック自体は搭載されていそうな感じがします。
見てみると、UTC保存で、15 分ほどズレた時刻になっていました。
上のような方法でシステムの時計だけ合わせていたので、リアルタイムクロックのほうには反映されていなかった可能性があります。
UTCであることだけ注意して、時々反映してあげるといいかも知れません。

### 有線LANポート

本体カバーを開けると有線LANポートがあります。
天井側から差し込む向きについています。
差し込み口の埃対策カバーみたいなものがついていますが、それは手前に引っ張ると外れます。

このポート用にDHCPクライアント(udhcpc)が待機していて、普通にLANケーブルをつなぐとDHCPクライアントが動き出してIPアドレスを取得しに来ます。

無線LANがどうにもつながらなくなってしまった時の頼みの綱です。

### ログ

`/etc/config`ディレクトリの中に`khems.log`ファイルとlogrotateされたっぽいファイルが並んでいます。
ここにログが書き込まれるようなのですが、普段はなぜか以下のようなエラーメッセージで埋め尽くされていて参考になりません:

```
Aug  4 19:41:48 freescale user.warn KHEMS: [pid=2471( KHEMS_PCS),tid=3225] PCS_SerialInterface.cpp(498) readData():[Warning]:T6 Timeout in RS485 communication
```

しかし、専用アプリがつながらなくなるようなトラブルに遭遇した場合は、サービスが異常終了してログの更新が止まるので、ここのログを覗くと何かヒントが残っている場合があります。
例えば以下のメッセージはいかにも問題が起きていそうな内容でしょう:

```
May 17 22:04:52 freescale user.warn KHEMS: [pid=2543( KHEMS_MDM),tid=3203] MDM_Thread.cpp(454) vacuum():[Warning]:command:vacuum minute; sensor_average301.db Failure err=database or disk is full
```

### ECHONET Lite

ECHONET Liteという規格に対応しています。
NVF-01からは以下の2グループ3クラスが検出できます:

- 住宅・設備関連機器クラスグループ (クラスグループコード0x02)
  - 住宅用太陽光発電クラス (クラスコード0x79)
  - 分電盤メータリングクラス (クラスコード0x87)
- 管理・操作関連機器クラスグループ (クラスグループコード0x05)
  - コントローラクラス (クラスコード0xFF)

規格上、UDPポート3610が必須で、もちろん対応していますが、他にTCPポート3610も使用できるようになっています。
IPv4のみです。

専用アプリの通信をパケットキャプチャーすると、基本的にはこの規格に沿って最初にUDPで検出をした後は、TCPで通信しているようですが、ユーザー定義領域のEPCも使われているようです。
というのは、規格を見ても過去データを振り返る方法が見つかりません。
それをユーザー定義領域のEPCで実現しているようです。

瞬時値表示と積算値については規格の範囲内で読み取れます。
以下のEPCのプロパティを読み取ります:

- 住宅用太陽光発電クラス
  - 瞬時発電電力計測値, EPC 0xE0
  - 積算発電電力量計測値, EPC 0xE1
- 分電盤メータリングクラス
  - 瞬時電力計測値, EPC 0xC6
  - 積算電力量計測値 (正方向), EPC 0xC0
  - 積算電力量計測値 (逆方向), EPC 0xC1
  - 積算電力量単位, EPC 0xC2

発電電力の計測値は符号無しで、発電が止まっていれば0です。

瞬時電力の計測値は符号ありで、買電時は正の値、売電時は負の値です。
積算電力量単位は0x03となっていて、これは0.001 kWhを表します。
正方向は買っているほうの積算値、逆方向は売っているほうの積算値です。

ユーザー定義領域のEPCは、プロパティの書き込みと読み取りを一度に行うコマンド0x6Eを使ってアクセスされます。
詳しくはわかっていませんが、以下のような使われ方のようです:

- 0xF0: 長さ5バイト書き込み、日付を選択
- 0xF1: 長さ1バイト書き込み、時間単位や日単位などの単位を選択
- 0xF2: 読み取り、分電盤メータリングクラスと住宅用太陽光発電クラス
- 0xF3: 読み取り、分電盤メータリングクラスのみ

### Web

`/home/www-data`ディレクトリに、webでアクセスできる中身が詰まっています。
時計の設定の他、おそらく設置時に使われたであろう項目もあります。
PHPで書かれているようです。

他に`/home/khems/KHEMS_ECLD`ディレクトリと`/home/khems/KHEMS_CCLD`ディレクトリにもPHPが置かれているようですが、詳細は不明です。

### 起動処理

`/etc/rc.d/rc.local`にシェルスクリプトでいろいろ書かれています。
ubifsのマウントや、無線LAN関係の準備、webサーバーの起動などが行われ、メインプログラムが起動されます。

### 無線LANデバイス

どうやら無線LANデバイスはSDIO接続のようです。
dmesgを見ると、mmc0に対してaerialデバイスが登録され、rohm0というインターフェイスが作られているメッセージが残っています。

アクセスポイントになっていますが`wpa_supplicant`は使われていません。
独自方式のようです。

### USBポート

本体カバーを外すと、USBポートがひとつ、床の方向に出ています。
EHCIコントローラーがのっていてfsl-ehciドライバーが組み込まれています。
USBデバイスのドライバーとしては、ハブとマスストレージとヒューマンインターフェイスくらいしかなさそうです。
その他のドライバーを使いたいならカーネルモジュールをビルドして持ち込む必要があります。

マスストレージがあるのはファームウェアアップデートか何かを想定したものではないかと思いますが、ファームウェアアップデートの仕掛けは見つけていません。

### データベース

専用アプリから過去データを振り返ることができるわけですが、これはどうやらSQLite3のデータベースに保存されているようです。
データベースは少なくとも以下のディレクトリにはあります:

- `/var/cachedb`
- `/mnt/khems/equip`

`/var/cachedb`はrootfsのRAMディスク上に作られているものです。
拡張子は`.db`で、ファイルはたくさんあります。
ジャーナルは残されていません。

`/mnt/khems/equip`は永続ストレージのほうにあります。
こちらはどうやら`journal_mode` pragmaが`PERSIST`にセットされた状態でアクセスされるようです。
先頭がzeroで埋め尽くされた、拡張子が`.db-journal`となっているファイルが残されています。

データベースの中身については[Database.md](Database.md)に書いています。

### 2022年問題

2022年以降に問題が発生するようになりました。
詳しくは[Year2022problem.md](Year2022problem.md)に書いています。
